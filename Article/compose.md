# Compose

## ç®€ä»‹&ç‰¹ç‚¹

`compose` å‡½æ•°å¯ä»¥æ¥æ”¶å¤šä¸ªç‹¬ç«‹çš„å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œç„¶åå°†è¿™äº›å‡½æ•°è¿›è¡Œç»„åˆä¸²è”ï¼Œæœ€ç»ˆè¿”å›ä¸€ä¸ªâ€œç»„åˆå‡½æ•°â€ã€‚

â€œç»„åˆå‡½æ•°â€æ‰§è¡Œæ—¶ï¼Œå…¶å†…éƒ¨çš„æ‰€æœ‰å‡½æ•°éƒ½ä¼šæŒ‰ç…§ç»„åˆæ—¶çš„é¡ºåºå¹¶ä»¥é˜Ÿåˆ—çš„å½¢å¼æœ‰åºçš„æ‰§è¡Œï¼Œå‰ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼ä¼šä½œä¸ºä¸‹ä¸€ä¸ªå‡½æ•°çš„å‚æ•°è¢«æ¥æ”¶ï¼Œå› æ­¤â€œç»„åˆå‡½æ•°â€ä¸­çš„ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„å‡½æ•°å¯ä»¥æ¥æ”¶å¤šä¸ªå‚æ•°ï¼Œè€Œä¹‹åçš„å‡½æ•°åªèƒ½æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼ˆä¸Šä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼ï¼‰ã€‚åƒè¿™æ ·ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡å®šçš„å‚æ•°ä¼šä»â€œç»„åˆå‡½æ•°â€çš„å…¥å£å‡½æ•°ï¼ˆç¬¬ä¸€ä¸ªæ‰§è¡Œçš„å‡½æ•°ï¼‰ä¸­è¢«ä¼ å…¥ï¼Œè€Œä¹‹ååˆ™ä¼šåœ¨å¤šä¸ªç»„åˆä¸²è”çš„å‡½æ•°ç®¡é“ä¸­è¿›è¡ŒåŠ å·¥ã€ä¼ è¾“å’Œè¾“å‡ºã€‚

ç»„åˆå‡½æ•°çš„æ‰§è¡Œæ ¼å¼ä»¥åŠå‚æ•°åœ¨ç®¡é“ä¸­ä¼ è¾“çš„æ ¼å¼å¦‚ä¸‹ï¼š

```js
f(h(j(1, 2)));
```

**compose å‡½æ•°çš„ç‰¹ç‚¹:**

- å‚æ•°æ˜¯å¤šä¸ªå‡½æ•°ï¼Œè¿”å›å€¼æ˜¯ä¸€ä¸ªâ€œç»„åˆå‡½æ•°â€ã€‚
- ç»„åˆå‡½æ•°å†…çš„æ‰€æœ‰çš„å‡½æ•°ä»å³è‡³å·¦ä¸€ä¸ªä¸€ä¸ªæ‰§è¡Œï¼ˆä¸»è¦ç¬¦åˆæ•°å­¦ä»å³åˆ°å·¦çš„æ“ä½œæ¦‚å¿µï¼‰ã€‚
- ç»„åˆå‡½æ•°å†…é™¤äº†ç¬¬ä¸€ä¸ªæ‰§è¡Œå‡½æ•°çš„å‚æ•°æ˜¯å¤šå…ƒçš„ï¼Œå…¶å®ƒå‡½æ•°çš„å‚æ•°éƒ½æ˜¯æ¥æ”¶ä¸Šä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼ã€‚

**ä½¿ç”¨å½¢å¼ï¼š**

```js
let sayHello = (...str) => `Hello , ${str.join(" And ")}`;
let toUpper = str => str.toUpperCase();
let combin = compose(
  sayHello,
  toUpper
);

combin("jack", "bob"); // HELLO , JACK AND BOB
```

ç›¸æ¯”ä¸æ™®é€šçš„è°ƒç”¨æ–¹å¼ï¼Œå¤åˆå‡½æ•°çš„æ–¹å¼æ˜¯ä¸æ˜¯æ›´ç®€æ´ï¼Ÿç›´è§‚ï¼Ÿ

## çŸ¥è¯†ç‚¹

`compose` å‡½æ•°çš„æ ¸å¿ƒå°±åœ¨äºå¦‚ä½•å®ç°å¤šä¸ªå‡½æ•°çš„ç»„åˆä¸²è”ï¼Œé€šè¿‡å¯¹å¤šç§å®ç°æ–¹å¼çš„åˆ†æï¼Œåœ¨å¼€å§‹å®ç°`compose`å‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬æœ€å¥½äº‹å…ˆæŒæ¡ä»¥ä¸‹çŸ¥è¯†ç‚¹ï¼š

**å‡½æ•°åµŒå¥—è°ƒç”¨**

å½“å¤šä¸ªå‡½æ•°å­˜åœ¨åµŒå¥—è°ƒç”¨æ˜¯ï¼Œå…¶æ‰§è¡Œçš„é¡ºåºæ˜¯å…ˆå†…åå¤–ï¼Œä¸€å±‚ä¸€å±‚çš„æ‰§è¡Œã€‚

```js
a(b(c(d())));
// d() -> c() -> b() -> a()
```

æ•´ä¸ªè¿‡ç¨‹ï¼Œå°±å¦‚åŒä»å†…ä¸€å±‚ä¸€å±‚çš„å‰¥æ´‹è‘±çš®ã€‚

**é—­åŒ…**
ç®€å•æ¥è¯´ï¼Œå½“ä¸€ä¸ªå‡½æ•°ä½œä¸ºè¿”å›å€¼è¢«å¦ä¸€ä¸ªå‡½æ•°è¿”å›æ—¶ï¼Œå¹¶ä¸”ä½œä¸ºè¿”å›å€¼çš„å‡½æ•°æœ‰è®¿é—®å…¶çˆ¶çº§å‡½æ•°ä½œç”¨åŸŸçš„æ ‡è¯†ç¬¦ï¼ˆå˜é‡ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªè¿”å›å€¼å‡½æ•°ä¹Ÿå°±æ˜¯â€œé—­åŒ…å‡½æ•° (closure)â€ã€‚

```js
function example() {
  var fnName = arguments.callee.name;
  return function closure() {
    console.log(fnName);
  };
}
```

**é€’å½’**
â€œé€’å½’(recursion)â€ï¼Œå…¶å®å°±æ˜¯å‡½æ•°è‡ªå·±è°ƒç”¨è‡ªå·±ã€‚å¸¸ç”¨äºå¤šå±‚åµŒå¥—ä½†æ•°æ®ç»“æ„è¾ƒä¸ºå›ºå®šçš„åœºæ™¯ï¼Œä»¥å¿«é€Ÿå¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚

```js
var ids = [];
var data = {
  id: "001",
  child: {
    id: "0002",
    child: {
      id: "0003"
    }
  }
};

function recursion(data) {
  if ("child" in data) {
    ids.push(data.id);
    arguments.callee(data.child);
  }
}

recursion(data);
```

## å®ç° & æ€è·¯

å‡è®¾ä½œä¸ºå‚æ•°çš„å¤šä¸ªå‡½æ•°å¦‚ä¸‹ï¼š

```js
function a(a) {
  console.log(a);
  return a + "a";
}
function b(b) {
  console.log(b);
  return b + "b";
}
function c(c) {
  console.log(c);
  return c + "c";
}
var funs = [a, b, c];
```

### ç®€å•çš„æ —å­ ğŸŒ°

æ ¹æ® `compose`å‡½æ•°çš„æ ¸å¿ƒå®šä¹‰ï¼Œå³å®ç°å‡½æ•°çš„ç»„åˆä¸²è”ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­æ¥ç›´è§‚äº†è§£

```js
var compose = function(x, y) {
  return function() {
    x(y.apply(this, arguments));
  };
};

compose(
  a,
  b
)(1); //'1ba'
```

è™½ç„¶åªæ˜¯å°†ä¸¤ä¸ªå›ºå®šçš„å‚æ•°å‡½æ•°è¿›è¡Œä¸²è”è°ƒç”¨ï¼Œä½†æ˜¯ä¹Ÿè¶³ä»¥è®©æˆ‘ä»¬å¯¹ `compose`å‡½æ•°çš„æ•´ä½“å®ç°æœ‰ä¸€ä¸ªç›´è§‚çš„äº†è§£ã€‚

### é—­åŒ… + å¾ªç¯çš„æ–¹å¼

æˆ‘ä»¬å°†ä»‹ç»ä¸¤ç§é€šè¿‡é—­åŒ…ç»“åˆå¾ªç¯æ¥å®ç° `compose` å‡½æ•°çš„æ–¹å¼ã€‚
ç¬¬ä¸€ç§æ˜¯åœ¨å¾ªç¯ä¸­é€šè¿‡ç«‹å³æ‰§è¡Œå‡½æ•°è¡¨è¾¾å¼ï¼ˆIIFEï¼‰ä»¥é—­åŒ…çš„æ–¹å¼å®ç°å¤šä¸ªå‡½æ•°çš„åµŒå¥—ç»„åˆä¸²è”ã€‚

```js
function compose(funs) {
  var combin = null;
  for (var i = 0; i < funs.length; i++) {
    combin = (function(i, combin) {
      return combin
        ? function(args) {
            return combin(funs[i](args));
          }
        : function(args) {
            return funs[i](args);
          };
    })(i, combin);
  }
  return combin;
}
```

å¦ä¸€ç§æ–¹å¼ï¼Œåˆ™æ˜¯ä¸ä¹‹å®Œå…¨ç›¸åï¼Œè¿”å›çš„é—­åŒ…å‡½æ•°ä¸­é€šè¿‡å¾ªç¯æ¥é¡ºåºæ‰§è¡Œä¼ å…¥çš„å¤šä¸ªå‡½æ•°ï¼Œå¹¶è®©ä¸Šä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼ä½œä¸ºä¸‹ä¸€ä¸ªå‡½æ•°å‚æ•°ã€‚

```js
function compose(funs) {
  var len = funs.length;
  var index = len - 1;
  return function() {
    var result = len ? funs[index].apply(this, arguments) : arguments[0];
    while (--index >= 0) {
      result = funs[index].call(this, result);
    }
    return result;
  };
}
```

### é—­åŒ… + é€’å½’æ–¹å¼

è¿™ç§æ–¹å¼çš„æ€è·¯åˆ™æ˜¯é€šè¿‡â€œé€’å½’â€çš„ç‰¹æ€§æ¥æ›¿ä»£å¾ªç¯ï¼Œä½†æ˜¯ç¼–ç çš„æ€è·¯ä¾ç„¶æ˜¯æƒ³é€šçš„ã€‚

```js
function compose(...arr) {
    return function (...arr2) {
        (function aa(n) {
            if (n < arr.length - 1) {
                return arr[n](<aa(++n) >)
            } else {
                return arr[n](...arr2);
            }
        })(0)
    }
}
```

```js
var compose = function(...fns) {
  var len = fns.length; // è®°å½•æˆ‘ä»¬ä¼ å…¥æ‰€æœ‰å‡½æ•°çš„ä¸ªæ•°
  var index = len - 1; // æ¸¸æ ‡è®°å½•å‡½æ•°æ‰§è¡Œæƒ…å†µ, ä¹Ÿä½œä¸ºæˆ‘ä»¬è¿è¡Œ fns ä¸­çš„ä¸­å‡½æ•°çš„ç´¢å¼•
  var reslut; // ç»“æœ, æ¯æ¬¡å‡½æ•°æ‰§è¡Œå®Œæˆå, å‘ä¸‹ä¼ é€’
  return function f1(...arg1) {
    reslut = fns[index].apply(this, arg1);
    if (index <= 0) {
      index = len - 1;
      return reslut;
    }
    --index;
    return f1.call(null, reslut);
  };
};
```

### æ›´ç®€æ´çš„ ES6 æ–¹å¼ã€‚

```js
function compose(...funcs) {
  if (funcs.length === 0) {
    return arg => arg;
  }

  if (funcs.length === 1) {
    return funcs[0];
  }

  return funcs.reduce((a, b) => (...args) => a(b(...args)));
}
```

ç¨å¾®æ”¹å˜ä¸€ä¸‹ï¼š

```js
function compose(...funs) {
  if (funs.length === 0) {
    return arg => arg;
  }
  if (funs.length === 1) {
    return funs[0];
  }

  return funs.reverse().reduce((a, b) => (...arg) => b(a(arg)));
}
```

## pipe

å‰é¢æˆ‘ä»¬æåˆ°è¿‡ï¼Œâ€œç»„åˆå‡½æ•°â€åœ¨æ‰§è¡Œæ—¶ï¼Œå…¶å†…éƒ¨çš„æ‰€æœ‰å‡½æ•°ä¼šæŒ‰ç…§ç»„åˆçš„é¡ºåºä»¥é˜Ÿåˆ—çš„å½¢å¼æœ‰åºçš„æ‰§è¡Œï¼Œå› æ­¤å¾ˆæ˜æ˜¾ `compose` å‡½æ•°è¿”å›çš„ç»„åˆå‡½æ•°ï¼Œå…¶é¡ºåºæ˜¯ä»å³è‡³å·¦ï¼Œè€Œ `pipe` å‡½æ•°åˆ™ä¸å…¶å®Œå…¨ç›¸åï¼Œå®ƒè¿”å›çš„ç»„åˆå‡½æ•°å…¶æ‰§è¡Œé¡ºåºæ˜¯ä»å·¦è‡³å³ï¼Œæ›´ç¬¦åˆäººä»¬çš„ä¹ æƒ¯ã€‚

å®ç° `pipe`å‡½æ•°éå¸¸ç®€å•ï¼Œåªéœ€è¦å¯¹ `compose` å‡½æ•°çš„åŒ…è£¹é¡ºåºè¿›è¡Œè°ƒæ•´ä¸€ä¸‹å³å¯ã€‚

## å‚è€ƒ

> https://segmentfault.com/a/1190000008394749
